name: ğŸš€ BraveBot CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“‹ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov flake8 black
    
    - name: ğŸ” Lint Code
      run: |
        black --check --diff . || echo "âš ï¸ Code formatting issues found"
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸ Linting issues found"
    
    - name: ğŸ§ª Run Basic Tests
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        DATABASE_URL: sqlite:///test_bravebot.db
      run: |
        python -c "
        import sys
        import sqlite3
        
        # Test database creation
        conn = sqlite3.connect('test_bravebot.db')
        conn.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER)')
        conn.close()
        
        # Test imports
        try:
            import streamlit
            import plotly
            import pandas
            import requests
            print('âœ… All core dependencies imported successfully')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            sys.exit(1)
        "

  deploy:
    name: ğŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Prepare Deployment
      run: |
        echo "ğŸš€ Preparing deployment..."
        echo "ğŸ“… Deploy time: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        
        # Check critical files
        if [ ! -f requirements.txt ]; then
          echo "âŒ requirements.txt missing"
          exit 1
        fi
        
        if [ ! -f Dockerfile ]; then
          echo "âŒ Dockerfile missing"
          exit 1
        fi
        
        echo "âœ… Deployment files ready"
    
    - name: ğŸ” Debug Secrets
      run: |
        echo "Checking Railway token availability..."
        if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "âŒ RAILWAY_TOKEN secret is empty or not set"
          echo "ğŸ“‹ Available secrets (names only):"
          echo "- Check your repository secrets in Settings"
        else
          echo "âœ… RAILWAY_TOKEN secret is available"
          echo "ğŸ“ Token length: ${#RAILWAY_TOKEN}"
        fi
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: ğŸš‚ Deploy to Railway
      run: |
        # Install Railway CLI
        npm install -g @railway/cli@latest
        
        # Login using token
        echo "${{ secrets.RAILWAY_TOKEN }}" | railway login --token
        
        # Deploy
        railway deploy --service=bravebot
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: âœ… Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ BraveBot deployed successfully!"
        echo "ğŸ”— Check your Railway dashboard for the live URL"
        echo "ğŸ“Š Dashboard will be available shortly"
    
    - name: âŒ Deployment Failure
      if: failure()
      run: |
        echo "ğŸ’¥ Deployment failed!"
        echo "ğŸ” Check Railway logs for detailed error information"
        echo "ğŸ’¡ Common fixes:"
        echo "   â€¢ Check requirements.txt syntax"
        echo "   â€¢ Verify RAILWAY_TOKEN secret"
        echo "   â€¢ Review Dockerfile configuration"

  notify:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: ğŸ“Š Deployment Summary
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "ğŸ”— BraveBot is now live on Railway"
          echo "ğŸ“Š Dashboard URL: Check Railway console"
        else
          echo "âŒ DEPLOYMENT FAILED"
          echo "ğŸ” Check the logs above for error details"
          echo "ğŸ’¡ Next steps:"
          echo "   1. Fix the identified issues"
          echo "   2. Push changes to main branch"  
          echo "   3. Deployment will retry automatically"
        fi
