#!/usr/bin/env python3
"""
ğŸš€ BraveBot v2.0 Launcher - Fixed Version
========================================
Ù…Ø´ØºÙ„ Ù…Ø­Ø³Ù† Ù…Ø¹ Ø­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ¶Ø§Ø±Ø¨
"""

import os
import sys
import time
import subprocess
import threading
from pathlib import Path

def check_dependencies():
    """ÙØ­Øµ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª"""
    print("ğŸ“¦ ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª...")
    
    required_packages = [
        'python-telegram-bot',
        'streamlit', 
        'plotly',
        'pandas',
        'numpy',
        'python-dotenv',
        'requests'
    ]
    
    missing_packages = []
    
    for package in required_packages:
        try:
            __import__(package.replace('-', '_'))
        except ImportError:
            missing_packages.append(package)
    
    if missing_packages:
        print(f"âŒ Ù…ÙƒØªØ¨Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©: {', '.join(missing_packages)}")
        print("ğŸ”§ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª...")
        
        for package in missing_packages:
            subprocess.run([sys.executable, '-pip', 'install', package], 
                         capture_output=True)
        
        print("âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª")
    else:
        print("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…ØªÙˆÙØ±Ø©")

def check_files():
    """ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"""
    print("ğŸ“ ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª...")
    
    required_files = [
        'main.py',
        'dashboard_simple.py',
        'conflict_checker.py',
        '.env'
    ]
    
    missing_files = []
    for file in required_files:
        if not os.path.exists(file):
            missing_files.append(file)
    
    if missing_files:
        print(f"âŒ Ù…Ù„ÙØ§Øª Ù…ÙÙ‚ÙˆØ¯Ø©: {', '.join(missing_files)}")
        
        if '.env' in missing_files:
            print("ğŸ’¡ Ø£Ù†Ø´Ø¦ Ù…Ù„Ù .env ÙˆØ£Ø¶Ù:")
            print("   TELEGRAM_TOKEN=your_bot_token_here")
        
        return False
    
    print("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©")
    return True

def run_conflict_check():
    """ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„ØªØ¶Ø§Ø±Ø¨"""
    print("ğŸ” ÙØ­Øµ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø¨ÙˆØª...")
    
    try:
        result = subprocess.run([sys.executable, 'conflict_checker.py'], 
                              capture_output=True, text=True, timeout=30)
        
        print(result.stdout)
        if result.stderr:
            print("âš ï¸", result.stderr)
        
        return result.returncode == 0
    except subprocess.TimeoutExpired:
        print("â° Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ÙØ­Øµ Ø§Ù„ØªØ¶Ø§Ø±Ø¨")
        return False
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ØªØ¶Ø§Ø±Ø¨: {e}")
        return False

def run_dashboard():
    """ØªØ´ØºÙŠÙ„ Dashboard ÙÙŠ thread Ù…Ù†ÙØµÙ„"""
    try:
        print("ğŸ“Š ØªØ´ØºÙŠÙ„ Dashboard...")
        subprocess.run([
            sys.executable, '-m', 'streamlit', 'run', 
            'dashboard_simple.py', 
            '--server.port', '8501',
            '--server.headless', 'true'
        ], check=True)
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Dashboard: {e}")

def run_bot():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    try:
        print("ğŸ¤– ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        subprocess.run([sys.executable, 'main.py'], check=True)
    except KeyboardInterrupt:
        print("\nâ¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙˆØª: {e}")

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    print("ğŸš€ BraveBot v2.0 Launcher")
    print("=" * 50)
    
    # ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
    check_dependencies()
    
    # ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª
    if not check_files():
        print("âŒ Ù…Ù„ÙØ§Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ÙÙ‚ÙˆØ¯Ø©!")
        input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")
        return
    
    # Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    while True:
        print("\nğŸ“‹ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„:")
        print("1. ğŸ” ÙØ­Øµ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ ÙÙ‚Ø·")
        print("2. ğŸ“Š ØªØ´ØºÙŠÙ„ Dashboard ÙÙ‚Ø·")
        print("3. ğŸ¤– ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙ‚Ø·")
        print("4. ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙƒØ§Ù…Ù„Ø§Ù‹")
        print("5. âŒ Ø®Ø±ÙˆØ¬")
        
        choice = input("\nğŸ‘‰ Ø§Ø®ØªÙŠØ§Ø±Ùƒ (1-5): ").strip()
        
        if choice == '1':
            run_conflict_check()
        
        elif choice == '2':
            print("\nğŸ“Š ØªØ´ØºÙŠÙ„ Dashboard...")
            print("ğŸŒ Ø§ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰: http://localhost:8501")
            run_dashboard()
        
        elif choice == '3':
            if run_conflict_check():
                run_bot()
            else:
                print("âŒ ÙØ´Ù„ ÙØ­Øµ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ - Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª")
        
        elif choice == '4':
            print("\nğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„...")
            
            if not run_conflict_check():
                print("âŒ ÙØ´Ù„ ÙØ­Øµ Ø§Ù„ØªØ¶Ø§Ø±Ø¨")
                continue
            
            # ØªØ´ØºÙŠÙ„ Dashboard ÙÙŠ thread Ù…Ù†ÙØµÙ„
            dashboard_thread = threading.Thread(target=run_dashboard, daemon=True)
            dashboard_thread.start()
            
            time.sleep(3)  # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Dashboard
            print("ğŸ“Š Dashboard Ù…ØªØ§Ø­ Ø¹Ù„Ù‰: http://localhost:8501")
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
            run_bot()
            
        elif choice == '5':
            print("ğŸ‘‹ ÙˆØ¯Ø§Ø¹Ø§Ù‹!")
            break
        
        else:
            print("âŒ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nğŸ‘‹ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: {e}")
        input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")